name: Auto-Update Dependencies

on:
  schedule:
    # Executa toda segunda-feira Ã s 9h UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: Update dependencies
        run: |
          npm update
          npm audit fix --force || true
          
      - name: Run tests after update
        run: |
          npm run type-check
          npm run test
          
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'chore: automated dependency updates'
          body: |
            ðŸ¤– Automated dependency updates
            
            This PR updates project dependencies to their latest versions.
            
            **Changes:**
            - Updated npm packages to latest compatible versions
            - Applied security fixes where available
            
            **Testing:**
            - âœ… Type checking passed
            - âœ… All tests passed
            
            Please review the changes before merging.
          branch: chore/automated-dependency-updates
          delete-branch: true

  check-security:
    name: Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: Run security audit
        run: |
          npm audit --audit-level high
          
      - name: Check for vulnerabilities
        run: |
          npx audit-ci --high
          
      - name: Create issue if vulnerabilities found
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Security vulnerabilities detected',
              body: `
                ## Security Alert
                
                High or critical security vulnerabilities were detected in project dependencies.
                
                **Action Required:**
                - Review the security audit results
                - Update vulnerable packages
                - Test the application thoroughly
                
                **Check the logs:**
                - [Security Audit Results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                
                This issue was automatically created by the security check workflow.
              `,
              labels: ['security', 'high-priority', 'automated']
            })
